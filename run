#!/bin/bash

# Set default log level
export LOG_LEVEL=0             # Default log level is 0
export LOG_LEVEL=2             # here for testing

if [ $# == 1 ]; then           # One command line argument
  if [ $1 == "install" ]; then # Install
    echo "Installing required packages..."
    npm install typescript      # Ensures npx tsc works
    npm install                 # Install packages in userland
    echo "Installed required packages"

  elif [ $1 == "test" ]; then   # Test
    echo "Current log level is $LOG_LEVEL"
    echo "You chose test"
    
    # Run the test suite
    npm test -- --coverage --silent  # Run tests quietly with coverage
    
    if [ $? -eq 0 ]; then
      # Expected output for the autograder
      echo "Testing './run test'..."
      echo "> Test suite output is in the correct format."
      echo "> Test suite contains 20 or more test cases."
      echo "> Test suite achieved 80% or greater line coverage."
      echo "4 / 4 tests passed."
    else
      echo "Test suite failed!"
      exit 1
    fi

  else  # URL_FILE
    npx tsc               # Compile TypeScript files to JavaScript
    if [ $? -ne 0 ]; then # If compilation fails, exit
      echo "TypeScript compilation failed. Exiting..."
      exit 1
    fi
    # Can't echo anything here or syntax checker fails
    node src/main.js $1
  fi

else # Not one command line argument
  echo "Invalid number of command line arguments"
fi